---
title: "On the inference of positive and negative interactions and their relation to abundance"
author: "Andrew J. Rominger"
output:
  pdf_document:
    fig_caption: yes
    keep_tex: no
    number_sections: no
csl: nature.csl
bibliography: RarePlusComMinus.bib
---

A recent paper, Calatayuda et al. [@calatayud2019] infered species-species interaction networks from spatially replicated abundance data and found that positive interactions were associated with more rare species compared to negative interactions being associated with common species. Here, I show that these results cannot be assigned a biological interpretation because they are readily recreated with completely random data simulated without any species interactions.  

Things to discuss

- error rates with matrix permutations 
- neg binom ssad [@kendall1949; @nachman2000; @engen2008; @zillio2010; @connolly2017]
- neg binom v. poisson test for ssad's
- does the null model lead to poisson ssad's in the null permutations?




```{r setup}
library(knitr)
opts_chunk$set(echo = TRUE, cache = TRUE, 
               fig.width = 4, fig.height = 4, fig.align = 'center')

library(pika)
library(RarePlusComMinus)
library(parallel)
library(MASS)
library(socorro)
library(viridis)

# threading defaults
nthrd <- detectCores()
nthrd <- ifelse(round(nthrd * 0.8) >= nthrd - 1, nthrd - 1, round(nthrd * 0.8))
if(nthrd < 1) nthrd <- 1

# plotting defaults
parArgs <- list(mar = c(3, 3, 0, 0) + 0.5, mgp = c(1.5, 0.30, 0), tcl = -0.25)
cexDefault <- 1.4
lwdDefault <- 2
```


First we reproduce some of the key results of ref. [@calatayud2019], namely how abundance relates to positive and negative association networks.

```{r obs_data}
# load data from paper
data('abundace_matrices')

# clean it
obsdat <- lapply(abun.mat, function(x) {
    x <- ceiling(x)
    x <- x[rowSums(x) > 0, colSums(x) > 0]
    
    return(x)
})
```

```{r obs_plusMinus_comp}
commStats <- mclapply(obsdat, mc.cores = nthrd,
                      FUN = function(x) unlist(plusMinus(x)))

commStats <- as.data.frame(do.call(rbind, commStats))

# remove studies with too few plus or minus links
commStats[is.na(commStats$pos.rho.rho) | is.na(commStats$neg.rho.rho), ] <- NA
```

It should be noted that the authors of the original analysis [@calatayud2019] retained 326 studies after filtering, whereas we retain `r sum(!is.na(commStats$pos.wm))`. This may be in part because we removed any dataset for which there were fewer than three links in either the postive or negative networks, whereas the authors of the original analysis removed only those datasets with fewer than two links [@calatayud2019]. 

And now for the plot that reproduces Fig. 2 (b and c) from ref. [@calatayud2019].

```{r plusMinus_plotFuns, cache = FALSE}
# ----
# helper function for making fancy histograms
specialHist <- function(x, breaks, col, add = FALSE, ...) {
    h <- hist(x, breaks, plot = FALSE)

    if(!add) plot(range(h$breaks), range(h$counts), type = 'n', ...)

    rect(xleft = h$breaks[-length(h$breaks)], xright = h$breaks[-1], 
         ybottom = 0, ytop = h$counts, col = col)
}


# ----
# function to remake Fig 2(b-c)
fig2bc <- function(x, breaksRho, breaksWM, addxlab = TRUE) {
    # par(mar = rep(0, 4))
    # plot(1, type = 'n', axes = FALSE)
    plot.new()
    par(parArgs)
    par(cex = 1)
    
    fi <- split.screen(c(1, 2))
    
    # correlation differences
    screen(fi[1])
    
    par(parArgs)
    if(addxlab) {
        par(mar = parArgs$mar + c(0, 0, 0, -0.5))
        xlab <- 'Abundance-species degree differences\n(positive - negative)'
    } else {
        par(mar = parArgs$mar + c(-2.25, 0, 0, -0.5))
        xlab <- ''
    }
    
    specialHist(x$pos.rho.rho - x$neg.rho.rho, xlim = c(-2, 2),
                breaks = breaksRho, col = 'gray90',
                xlab = '', ylab = 'Number of assemblages')
    mtext(xlab, side = 1, line = 2.5)
    abline(v = 0, col = 'red', lty = 2, lwd = 2)
    
    
    # raw correlations
    fj <- split.screen(matrix(c(0.475 + 0.02, 0.975 + 0.02, 0.475, 0.975), nrow = 1), 
                        erase = FALSE)
    screen(fj, new = FALSE)
    
    par(parArgs)
    par(cex = 0.75)
    par(mgp = par('mgp') * par('cex'))
    
    specialHist(x$pos.rho.rho, xlim = c(-1, 1), ylim = c(0, 90),
                breaks = breaksRho / 2, col = hsv(0.65, alpha = 0.5),
                xlab = expression("Spearman's"~rho),
                ylab = '')
    specialHist(x$neg.rho.rho,
                breaks = breaksRho / 2, col = hsv(0, alpha = 0.5),
                add = TRUE)
    usr <- par('usr')
    points(usr[1] + c(0.2, 0.5) * diff(usr[1:2]), rep(usr[3] + 0.75 * diff(usr[3:4]), 2),
           cex = 3, bg = hsv(c(0.65, 0), alpha = 0.5), pch = 21)
    text(usr[1] + c(0.2, 0.5) * diff(usr[1:2]), rep(usr[3] + 0.75 * diff(usr[3:4]), 2),
         labels = c('+', '-'), cex = 2)
    
    
    # mean differences
    screen(fi[2])
    par(parArgs)
    if(addxlab) {
        par(mar = parArgs$mar + c(0, -1, 0, +0.5))
        xlab <- 'Abundance differences\n(positive - negative)'
    } else {
        par(mar = parArgs$mar + c(-2.25, -1, 0, +0.5))
        xlab <- ''
    }
    
    specialHist(x$pos.wm - x$neg.wm, xlim = c(-0.3, 0.3),
                breaks = breaksWM, col = 'gray90',
                xlab = '', ylab = '')
    mtext(xlab,
          side = 1, line = 2.5)
    abline(v = 0, col = 'red', lty = 2, lwd = 2)
    
    
    # raw means
    fk <- split.screen(matrix(c(0.475 - 0.04, 0.975 - 0.04, 0.475, 0.975), nrow = 1), 
                        erase = FALSE)
    screen(fk, new = FALSE)
    
    par(parArgs)
    par(cex = 0.75)
    par(mgp = par('mgp') * par('cex'))
    
    specialHist(x$pos.wm, xlim = c(0, 0.3),
                breaks = (breaksWM + 0.3) / 2, col = hsv(0.65, alpha = 0.5),
                xlab = 'Weighted mean abund.',
                ylab = '')
    specialHist(x$neg.wm,
                breaks = (breaksWM + 0.3) / 2, col = hsv(0, alpha = 0.5),
                add = TRUE)
    usr <- par('usr')
    points(usr[1] + (1 - c(0.5, 0.2)) * diff(usr[1:2]), 
           rep(usr[3] + 0.75 * diff(usr[3:4]), 2),
           cex = 3, bg = hsv(c(0.65, 0), alpha = 0.5), pch = 21)
    text(usr[1] + (1 - c(0.5, 0.2)) * diff(usr[1:2]), 
           rep(usr[3] + 0.75 * diff(usr[3:4]), 2),
         labels = c('+', '-'), cex = 2)
    
    close.screen(c(fi, fj, fk))
}
```

```{r obs_plusMinus_plot, fig.width = 7.5, fig.height = 4, cache = FALSE}
fig2bc(commStats, breaksRho = seq(-2, 2, by = 1/5), 
       breaksWM = seq(-0.3, 0.3, by = 0.1/3))
```


```{r fig2-estimates}
# estimate number of assembledges suggested by Fig 2c; number refer to arbitrary
# pixle coordinates from the figure rescaled to the y-axis units

y0 <- 517
ys <- c(173, 345)

r <- 220 / mean((y0 - ys) * 1:2)

yblu <- c(234, 399, 478, 498, 507, 507, 509, rep(512, 5))
yred <- c(498, 375, 403, 419, 467, 482, 505)

fig2est <- r * (sum((y0 - yblu)) + sum((y0 - yred)))
```

It should be noted that our inset figure of mean weighted abundances differs from the original paper [@calatayud2019] in that their y-axis ranges from 0 to 220, while ours ranges from 0 to 120; we suspected the original authors mislabled their axis, because the scale as presented would suggest over `r 100 * floor(fig2est / 100)` assembledges, while the number should be 326.  Rescaling their axis to range from 0 to 120 brings this estimate more in line with the reported number of assembledges.

Now we explore the shape of the spatial abundance patters in the real data provided by ref. @calatayud2019.


```{r ssad_comp}
summStats <- mclapply(1:length(obsdat), mc.cores = nthrd, FUN = function(i) {
    x <- obsdat[[i]]
    o <- sapply(1:ncol(x), function(j) {
        # sometimes optimization fails, so catch that and return NA
        params <- try(fitdistr(x[, j], 'negative binomial'))
        if(class(params) == 'try-error') {
            params <- c(size = NA, mu = NA, loglik = NA)
        } else {
            params <- c(params$estimate, loglik = params$loglik)
        }
        
        nocc <- sum(x[, j] > 0)
        abund <- sum(x[, j])
        
        return(c(nsite = nrow(x), nspp = ncol(x), nocc = nocc, abund = abund, J = sum(x),
                 params))
    })
})

summStats <- data.frame(study = rep(names(obsdat), sapply(summStats, ncol)),
                        t(do.call(cbind, summStats)))

# remove failed optims
summStats <- summStats[!is.na(summStats$size), ]

# looks like an optim bug around size = 100, remove it
summStats[round(summStats$size) == 100, c('size', 'mu', 'loglik')] <- NA
```

```{r ssad_plot, fig.width = 5, fig.height = 5, cache = FALSE, eval = FALSE}
# helper funciton for easy log-log ploits
llplot <- function(x, y, expLab = TRUE, ...) {
    plot(x, y, xaxt = 'n', yaxt = 'n', ...)
    logAxis(1:2, expLab = expLab)
}

layout(matrix(1:4, ncol = 2, byrow = TRUE))
par(parArgs)

llplot(summStats$nsite, summStats$J, log = 'xy',
     xlab = 'Number of sites', ylab = 'Number of individuals', 
       col = quantCol(summStats$nspp, viridis(40), 'log'))
llplot(summStats$J, summStats$nspp, log = 'xy',
     xlab = 'Number of individuals', ylab = 'Number of species', 
       col = quantCol(summStats$nspp, viridis(40), 'log'))
llplot(summStats$abund / summStats$nsite, summStats$mu, log = 'xy', 
       xlab = 'Mean abund. per site', ylab = expression(mu), 
       col = quantCol(summStats$nspp, viridis(40), 'log'))
llplot(summStats$abund / summStats$J, summStats$size, log = 'xy', 
       xlab = 'Relative abundance', ylab = expression(k), 
       col = quantCol(summStats$nspp, viridis(40), 'log'))
```

We can also get a sense for the SADs of each assembledge

```{r sad_comp}
mods <- c('fish', 'plnorm', 'tnegb')
sadStats <- mclapply(obsdat, mc.cores = nthrd, FUN = function(x) {
    x <- colSums(x)
    s <- fitSAD(x, mods)
    
    i <- which.min(sapply(s, AIC))
    o <- s[[i]]$MLE
    if(i == 1) o <- c(o, NA)
    
    o <- c(i, o)
    names(o) <- NULL
    
    return(o)
})

sadStats <- as.data.frame(do.call(rbind, sadStats))
names(sadStats) <- c('mod', 'par1', 'par2')
sadStats$mod <- mods[sadStats$mod]

# limit to only those sites that produced good networks
sadStats <- sadStats[rownames(sadStats) %in% 
                         rownames(commStats[!is.na(commStats$pos.n), ]), ]
```

We'll make linear models of the SSAD relationships to sample from in addition to sampling from the SAD

```{r ssad_lm}
# indBySiteMod <- lm(log(summStats$J) ~ log(summStats$nsite))
# data for linear model of k, excluding sites that didn't produce a good network
dat4k <- with(summStats[summStats$study %in%
                            rownames(commStats[!is.na(commStats$pos.n), ]), ],
              data.frame(logk = log(size),
                         loga = log(abund / J),
                         logS = log(nspp))
)

kByRelSppMod <- lm(logk ~ loga + logS, data = dat4k)

# function to generate k values from input number of species and abundances
kfunSpp <- function(nspp, abund) {
    J <- sum(abund)
    exp(predict(kByRelSppMod, newdata = data.frame(loga = log(abund / J),
                                                   logS = log(nspp))) +
            rnorm(nspp, sd = summary(kByRelSppMod)$sigma))
}
```


Now we can do a simulation where we make slightly more than `r sum(!is.na(commStats$pos.wm))` simulated communities (slightly more because some will be rejected) and see how their positive and negative associate networks look.

```{r sim_plusMinus_comp}
# number of simulations to run
nsim <- round(1.25 * sum(!is.na(commStats$pos.wm)))

# numbers of sites and species to sample from
# note: only using those sites that produced good networks
nsitenspp <- unique(summStats[
    summStats$study %in% rownames(commStats[!is.na(commStats$pos.n), ]), 
    c('study', 'nsite', 'nspp')])

# loop over simulation replicates
simPMData <- simPlusMinus(nsitenspp = nsitenspp, sadStats = sadStats, mcCores = nthrd, 
                          ssadType = 'nbinom', kfun = kfunSpp, nsim = nsim)
```

```{r sim_plusMinus_plot, fig.width = 7.5, fig.height = 4, cache = FALSE}
wmmax <- ceiling(max(simPMData$pos.wm, simPMData$neg.wm, na.rm = TRUE) * 9) / 3

fig2bc(simPMData, breaksRho = seq(-2, 2, by = 1/5), 
       breaksWM = seq(-wmmax, wmmax, by = 0.1/3))
```


Now we want to figure out if this is specifically because of the shape of the SSAD (i.e. negative binomial) or if a spatially unclustered SSAD would also yield this result. We do this by modeling the SSAD with a Poisson distribution and compare

```{r sim_pois_plusMinus_comp}
# loop over simulation replicates
simPMDataPois <- simPlusMinus(nsitenspp = nsitenspp, sadStats = sadStats, 
                              mcCores = nthrd, 
                              ssadType = 'pois', kfun = NULL, nsim = nsim)
```

```{r sim_pois_plusMinus_plot, fig.width = 7.5, fig.height = 4, cache = FALSE}
wmmax <- ceiling(max(simPMDataPois$pos.wm, simPMDataPois$neg.wm, na.rm = TRUE) * 9) / 3

fig2bc(simPMDataPois, breaksRho = seq(-2, 2, by = 1/5), 
       breaksWM = seq(-wmmax, wmmax, by = 0.1/3))
```

And lastly we might be interested in whether we need to use quantities from the dat so much. We might instead imagine one arbitrary SAD and one arbitrary negative binomial SSAD and see if qualitatively similar results are found.

```{r, sim_simple_nb_plusMinus_comp}
# stub
```

```{r, sim_simple_pois_plusMinus_comp}
# stub
```

Putting all plots together
```{r foo_plot, fig.width = 7.5, fig.height = 7.5, cache = FALSE, eval = FALSE}
split.screen(c(2, 1))
screen(1)
fig2bc(commStats, breaksRho = seq(-2, 2, by = 1/5), 
       breaksWM = seq(-0.3, 0.3, by = 0.1/3), addxlab = FALSE)

screen(2)
fig2bc(commStats, breaksRho = seq(-2, 2, by = 1/5), 
       breaksWM = seq(-0.3, 0.3, by = 0.1/3), addxlab = FALSE)
close.screen(all.screens = TRUE)
```
# References

