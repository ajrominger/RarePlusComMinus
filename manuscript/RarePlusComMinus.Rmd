---
title: "On the inference of positive and negative interactions and their relation to abundance"
author: "Andrew J. Rominger"
header-includes:
   - \usepackage{xr}
   - \externaldocument{RarePlusComMinus_supp}
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: no
csl: nature.csl
bibliography: RarePlusComMinus.bib
---



```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = FALSE, message = FALSE, warning = FALSE)

# function for cross-cache lazy loading
findChunk <- function(key, otherDoc) {
    f <- file.path(paste(otherDoc, 'cache', sep = '_'), 'latex')
    
    allChunk <- list.files(f, pattern = '.RData')
    
    thisChunk <- gsub('\\.RData', '', grep(paste0(key, '_'), allChunk, value = TRUE))
    thisChunk <- file.path(f, thisChunk)
    
    return(thisChunk)
}

# function for cross-doc figure referencing
refOtherFig <- function(x, otherDoc, prefix = '') {
    
}

# load packages
pkgs <- readLines('RarePlusComMinus_supp_cache/latex/__packages')
for(p in pkgs) library(p, character.only = TRUE)

# load plotting defaults
lazyLoad(findChunk('plot_defaults', 'RarePlusComMinus_supp'))
figW <- figH <- 3.75
knitr::opts_chunk$set(fig.width = figW, fig.height = figH, fig.align = 'center')

# load threading defaults
lazyLoad(findChunk('threading', 'RarePlusComMinus_supp'))
```



Why do rare species persist in ecosystems? Rare species seem to be at a disadvantage by pure probabilistic odds [@mcgill2005] and perhaps also from poorly adapted species-environment and species-species interactions [@hutchinson1961], though negative density-dependence may help rare species persist [@leigh2004; @yenni2012]. The question of rarity and persistence thus remains unresolved.  In a recent paper, Calatayuda et al. [@calatayud2019] (CEA) inferred species-species interaction networks from spatially replicated abundance data across many taxa and environments.  CEA found that rare species were associated with positive interactions whereas common species were associated with negative interactions, indicating that positive interactions, such as facilitation, may help rare species persist [@calatayud2019]. However, the use of abundance and co-occurrence data to infer species interactions is difficult and often inaccurate [@freilich2018; @carr2019; @rajala2019]. This issue arises in no small part because the underlying null models used to infer interactions themselves are known to have type I and II error problems in real world applications [@ulrich2010; @ladau2008]. Here, I show that the finding of rare species being more associated with positive interactions as found by CEA [@calatayud2019] can be explained by statistical artifacts in the inference of species interactions from abundance data. It would therefore not be supported to assign biological interpretations to these findings until more data can be brought to bear on the subject or interaction types and the persistence of rare species.

Species abundances are not evenly distributed across species [@hubbell2001; @mcgill2010; @harte2011], nor evenly distributed within species across space (often referred to as spatial clustering) [@engen2008; @zillio2010; @harte2011; @connolly2017].  These two simple observations account for the result of rare species being associated with positive interactions while common species appear associated with negative interactions.  When interaction networks are inferred from spatially replicated abundance data, a null model is used to assess whether patterns of species-species co-occurrences deviate substantially enough from null expectations to suggest a non-random interaction. However, if abundances are driven by factors, both probabilistic or deterministic, other than species-species interactions, these null models may not reveal true interactions, but artifacts of other processes  The unevenness of species abundances is ubiquitous and can be accounted for by purely probabilistic processes from neutral birth-death-immigration [@kendall1949, @hubbell2001] to mechanistically agnostic statistical-mechanical properties of large assemblages [@harte2011], thus the simple observation of uneven abundances does by itself indicate deterministic mechanisms.

The data compiled by CEA [@calatayud2019] indeed conform to the ubiquity of unevenness (Supplementary Figs. \ref{fig:ssad} and \ref{fig:sadShape}). To evaluate whether this drives the results about interaction type and abundance, in Figure \ref{fig:plusMinus} I first reproduce key results from CEA's Figure 2(b-c); I then simulate purely random data that match key characteristics of observed data but contain absolutely no species interactions. These random data are simulated as follows:

1) The number of species $S$, number of sites $M$, and shape of the best fitting species abundance distribution (SAD) are sampled (with replacement) from the observed data
2) $S$ species abundances $x_i \ldots x_S$ are sampled from the SAD
3) For each $x_i$, within-species counts are distributed across the $M$ sites according to a spatial species abundance distribution (SSAD) that is either negative binomial (in the case of spatial clustering) or Poisson (in the case of spatial evenness)
4) The resulting simulated site by species matrix is fed through the same pipeline as the observed data (described in CEA [@calatayud2019]) to infer positive and negative interactions.

All analyses are carried out in R [@rcore] and can be fully reproduced by installing the R package accompanying this paper, as detailed in the supplement.

In the case of a Poisson SSAD the one parameter (the mean) is fully specified by the average site-level abundance of a given species. In the case of a negative binomial SSAD, the mean parameter is again specified by the site-level average, but the size or clustering parameter $k$ is not fully specified.  To capture the rough features of the data, I sample $k$ from a linear relationship (with noise) between the maximum likelihood estimates of $k$ and the relative abundance of each species.

```{r fig_plusMinus_prep, include = FALSE}
# load plotting funs
lazyLoad(findChunk('plusMinus_plotFuns', 'RarePlusComMinus_supp'))

# load all data to plot
lazyLoad(findChunk('obs_plusMinus_comp', 'RarePlusComMinus_supp'))
lazyLoad(findChunk('sim_plusMinus_comp', 'RarePlusComMinus_supp'))
lazyLoad(findChunk('sim_pois_plusMinus_comp', 'RarePlusComMinus_supp'))
# lazyLoad(findChunk('sim_poisUnif_plusMinus_comp', 'RarePlusComMinus_supp'))
```

```{r fig_plusMinus, fig.width = figW * 2, fig.height = figH * 2.4, fig.cap = 'Distributions of correlations between network centrality and abundance (left panels) and weighted mean abundance by network type (right panels). The results of CEA Figure 2(B-C) are reproduced in this figure panels A-B; panels C-D show data simulated with a negative binomial SSAD and no species interactions; panels E-F show data simulated with a Poisson SSAD and again no species interactions. \\label{fig:plusMinus}'}
wmmax <- ceiling(max(simPMData$pos.wm, simPMData$neg.wm, na.rm = TRUE) * 9) / 3
xless <- 0.48
yextra <- 0.55

foo <- split.screen(c(3, 1))

screen(1)
fig2bc(commStats, breaksRho = seq(-2, 2, by = 1/5), 
       breaksWM = seq(-wmmax, wmmax, by = 0.1/3), addxlab = FALSE, 
       figLabs = c('A', 'B'), insetxprop = xless, insetyprop = yextra)
mtext('Observed', side = 4, outer = TRUE)

screen(2)
fig2bc(simPMData, breaksRho = seq(-2, 2, by = 1/5),
       breaksWM = seq(-wmmax, wmmax, by = 0.1/3), addxlab = FALSE,
       figLabs = c('C', 'D'), insetxprop = xless, insetyprop = yextra)

screen(3)
fig2bc(simPMDataPois, breaksRho = seq(-2, 2, by = 1/5),
       breaksWM = seq(-wmmax, wmmax, by = 0.1/3), addxlab = TRUE,
       figLabs = c('E', 'F'), insetxprop = xless, insetyprop = yextra)

foo <- close.screen(all.screens = TRUE)
```

Figure \ref{fig:plusMinus} shows that with a negative binomial SSAD, the simulated data closely match the observed findings. This correspondence largely disappears when we instead use a Poisson SSAD, highlighting the importance of spatial aggregation in driving the spurious results.  However, we still observe a slight skew toward rare species being slightly more prevalent with positive interactions (Fig. \ref{fig:plusMinus}F). 

<!-- To investigate this further, I sample from uniform species abundances, again with Poisson spatial distributions. Now there is no skewed association between abundance and interaction type (Fig. \ref{fig:plusMinus}). -->

These findings do not depend on simulating SAD and SSAD shapes from the data: in Supplementary Figure \ref{fig:simpleSim} I show that the spurious relationship between abundance and interaction type occurs even when simulating data from just one arbitrary SAD function with the one arbitrary spatially clustered SSAD for all species.  In this simulation, again, replacing the spatially clustered SSAD with a Poisson SSAD breaks the spurious association as in Figure \ref{fig:plusMinus}.

We seek to understand why negative binomial SSADs reproduce the results while Poisson SSADs fail to. The null model algorithm used here and in CEA [@calatayud2019] fixes row and column marginals, but within any given species, the way its total abundance is allocated across sites by the null model has a potentially large combinatorial space to explore. I compare known SSADs to their permuted counterpart in Figure \ref{fig:ssadPerm} and find that the null model transforms negative binomial SSADs to a more Poisson shape, while leaving Poisson SSADs probabilistically unchanged. Specifically, when starting with a negative binomial SSAD, the null model inflates the number of sites individuals are allocated to (more similarly to a Poisson SSAD) and consequently the inferred $k$ parameter of these permuted SSADs is increase, indicating less spatial clustering.

```{r ssadPerm_prep, include = FALSE}
lazyLoad(findChunk('ssad_perm_comp', 'RarePlusComMinus_supp'))
```

```{r ssadPerm_plot, fig.width = figW * 1.75, fig.cap = "Comparison of true and permuted SSADs in terms of number of sites occupied (A) and inferred clustering parameter $k$ (B). Points are semi-transparent to help display density. Lines are 1:1 lines. \\label{fig:ssadPerm}"}
nbCol <- hsv(0.53, 1, 0.8)
poCol <- hsv(0.1, 1, 0.95)

layout(matrix(c(1, 1, 2, 3), nrow = 2, byrow = TRUE), heights = c(1, 5))

lmar <- parArgs$mar
lmar[c(1, 3)] <- 0
par(mar = lmar)

plot(1, type = 'n', axes = FALSE, xlab = '', ylab = '')
legend(1, 1, legend = c('Negative binomial', 'Poisson'), pch = 21, pt.cex = 2,
       col = c(nbCol, poCol), pt.bg = colAlpha(c(nbCol, poCol), 0.4),
       bty = 'n', horiz = TRUE, xjust = 0.5)

par(parArgs)
plot(simPoPerm$nocc, simPoPerm$null_nocc, pch = 21,
     col = poCol, bg = colAlpha(poCol, 0.1),
     xlim = c(1, nsite), ylim = c(1, nsite),
     xlab = 'True num. occupied sites',
     ylab = 'Permuted num. occupied sites')

points(simNBPerm$nocc, simNBPerm$null_nocc,
       pch = 21, col = nbCol, bg = colAlpha(nbCol, 0.1))

abline(0, 1, col = 'black', lwd = 2)


foo <- rbind(simNBPerm, simPoPerm)
foo <- foo[is.finite(foo$size) & is.finite(foo$null_size), ]

par(parArgs)
plot(simPoPerm$size, simPoPerm$null_size, log = 'xy', xaxt = 'n', yaxt = 'n',
     pch = 21, col = poCol, bg = colAlpha(poCol, 0.1),
     xlim = range(foo[, c('size', 'null_size')]),
     ylim = range(foo[, c('size', 'null_size')]),
     xlab = expression('True'~k),
     ylab = expression('Permuted'~k))
logAxis(1:2, expLab = TRUE)

points(simNBPerm$size, simNBPerm$null_size,
       pch = 21, col = nbCol, bg = colAlpha(nbCol, 0.1))

abline(0, 1, lwd = 1.5)
```

```{r, mathEG_prep, include = FALSE}
lazyLoad(findChunk('mathmat_fun', 'RarePlusComMinus_supp'))
lazyLoad(findChunk('mathEG_setup', 'RarePlusComMinus_supp'))
lazyLoad(findChunk('mathEG_rare', 'RarePlusComMinus_supp'))
lazyLoad(findChunk('mathEG_comm', 'RarePlusComMinus_supp'))
lazyLoad(findChunk('mathEG_commMax', 'RarePlusComMinus_supp'))

formatNice <- function(x) {
    o <- formatC(x, format = 'e', digits = 2)
    o <- gsub('e', ' \\\\times 10^{', o)
    o <- gsub('10\\^\\{-0', '10^\\{-', o)
    o <- gsub('10\\^\\{0', '10^\\{', o)
    
    return(paste0(o, '}'))
}
```

At a mathematical level, clustered SSADs, compared to spatially even SSADs, actually increase the probability that rare species will appear aggregated with each other and common species will appear repelled, this difference between clustered and even SSADs explains the results.  Consider for example two rare species, one with a single individual and the other with abundance `r Nrare`, distributed across `r nsite` sites. Their Schoener similarity is maximized when all individuals occur in the same site, such as 
$$
`r mathmat(rarePair)`
$$
If we define $Q(x_i; \mu = `r Nrare / nsite`)$ as the probability of observing $x_i$ individuals in site $i$ given an SSAD with mean parameter $\mu$, then the probability of the above configuration is $Q(`r Nrare`; \mu = `r Nrare / nsite`) Q(0; \mu = `r Nrare / nsite`)^`r nsite - 1`$. Under a negative binomial SSAD with $k = `r k`$ this equals $`r formatNice(nbRareP)`$ whereas under a Poisson SSAD this equals $`r formatNice(poRareP)`$. 

Conversely, for two common species, say each with abundance `r Ncomm`, an example configuration that *minimizes* their Schoener similarity would be
$$
`r mathmat(commPair)`
$$
We calculate the probability of any such scenario where no abundances overlap as $`r nsite - 1` [Q(`r Ncomm`; \mu = `r Ncomm / nsite`) Q(0; \mu = `r Ncomm / nsite`)^{`r nsite - 1`}]^2$. With a negative binomial SSAD with $k = `r k`$ this equals $`r formatNice(nbCommP)`$ whereas with a Poisson SSAD this equals $`r formatNice(poCommP)`$.

We can contrast this a configuration that would maximize the Schoener similarity between these two common species:
$$
`r mathmat(commPairMax)`
$$
The probability of this configuration is $Q(`r commPairMax[1, 1]`; \mu = `r Ncomm / nsite`)^{`r 2 * nsite`}$ which, for the same negative binomial equals $`r formatNice(nbCommPMax)`$, and for the Poisson equals $`r formatNice(poCommPMax)`$.

Thus a clustered SSAD makes rare species appear aggregated, compared to an even SSAD that, if anything, makes common species appear more aggregated.  Because the null model algorithm preserves even SSADs this is less of an issue; however, when presented with spatially clustered abundances, the null model will spuriously identify rare species as aggregated and common species as repelling each other.  This statistical property accounts for the prevalence of rare species in positive interaction networks and common species in negative interaction networks. 

```{r}
# function to calculate percent of species in networks
percNet <- function(x, type) {
    round(mean(100 * x[, paste(type, 'v', sep = '.')] / x$all.v, na.rm = TRUE))
}
```

Great caution should be used when inferring species interactions from abundance data.  At an even more fundamental level than the spurious association of abundance with interaction type, in the purely random data sets simulated with a negative binomial SSAD, on average `r percNet(simPMData, 'pos')`% of species were placed in positive interaction networks and `r percNet(simPMData, 'neg')`% in negative interaction networks with a significance cutoff of $\alpha = 0.05$.  With the Poisson SSAD these simulated numbers were `r percNet(simPMDataPois, 'pos')`% for positive networks and `r percNet(simPMDataPois, 'neg')`% for negative networks.  For the observed data, on average `r percNet(commStats, 'pos')`% of species were placed in positive interaction networks and `r percNet(commStats, 'neg')`% in negative interaction networks. These are not robust estimates of species interaction.


\clearpage

# References

